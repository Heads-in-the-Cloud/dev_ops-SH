pipeline {
    agent {
        node {
            label 'aws-ready'
        }
    }

    environment {
        ECS_CONTEXT_NAME = "default"
        ORG_ECR_URI = "${ORG_ACCOUNT_NUM}.dkr.ecr.${region}.amazonaws.com"
        SECRET_ID = 'dev/SeanH/utopia-secrets'
    }

    stages {
        stage("Environment Loading") {
            steps {
                echo 'Environmental variables loading...'
            }
        }

        stage("Docker-Compose Set-Up") {
            steps {
                echo 'Setting up Docker context and getting repo credentials...'
                sh "docker context use ${ECS_CONTEXT_NAME}"
                sh "aws ecr get-login-password --region ${region} |docker login --username AWS --password-stdin ${ORG_ECR_URI}"
            }
        }

        stage("Docker-Compose Deployment") {
            steps {
                echo 'Bringing services online...'
                dir("jenkins-docker-compose") {
                    sh 'docker-compose up -d'
                }
            }
        }

        stage("Docker-Compose Running") {
            steps {
                echo 'Printing running services...'
                sh "docker ps"
            }
        }

        stage("Docker-Compose Take Down") {
            steps {
                echo 'Bringing services down...'
                dir("jenkins-docker-compose") {
                    sh 'docker compose down'
                }
                sh 'docker context use default'
            }
        }
    }
}
